<html>

<head>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.9.3/dist/vuetify.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vuetify@3.9.3/dist/vuetify.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css" />
    <!-- <link rel="stylesheet" href="https://fonts.bunny.net/css?family=roboto:400,500,700" /> -->

    <script src="./test.js"></script>


    </script>

    <style>
        html,
        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #app {
            width: 100%;
            height: 100%;
        }

        .app-main {
            /* display: grid;
            grid-template-columns: auto 1fr; */
            width: 100%;
            height: 100vh;
        }

        .faq-view-content {
            display: grid;
            grid-template-rows: auto 1fr;
            width: 100%;
            height: 100%;
        }

        .header {
            display: grid;
            grid-template-columns: 0.5fr 0.5fr;
            gap: 4px;
            padding: 16px;
            padding-bottom: 0px;
        }

        .panes {
            display: flex;
            height: 100%;
            width: calc(100% - 2px);
            overflow: hidden;
        }

        .panel {
            flex-grow: 0;
            flex-shrink: 0;
            flex-basis: 50%;
            min-width: 10%;
            padding: 10px;
            box-sizing: border-box;
            /* overflow: auto; */
        }

        .panel.first {
            flex-basis: 30%;
            padding-top: 0px;
        }

        .split-head {
            display: grid;
            grid-template-rows: auto auto 1fr;
            height: 100%;
        }

        .panel.second {
            flex-basis: 70%;
        }

        .splitter {
            width: 2px;
            cursor: ew-resize;
            user-select: none;
            flex-shrink: 0;
            background-color: #cfcfcf;
        }

        .splitter:hover {
            background-color: #888;
        }

        .v-list-item-title {
            user-select: none;
        }

        .overflow-container {
            overflow: auto;
            height: 100%;
        }

        .question-text {
            padding-top: 10px;
            padding-bottom: 10px;

            /* padding: 10px; */
            font-weight: bold;
        }

        .answer-text {
            /* font-size: 80%; */
            white-space: pre-wrap;
            width: 100%;
            field-sizing: content;
            padding: 10px;
            border: gray solid 1px;
        }

        .qa-item {
            padding-top: 10px;
            padding-bottom: 10px;
            display: grid;
            grid-template-rows: auto 1fr;

            gap: 8px;
        }

        .qa-item-head {
            display: flex;
            justify-content: stretch;
        }

        .qa-item-head .category {
            margin-left: auto;
        }

        .qa-item-memo-border {
            border: gray solid 1px;
        }

        .qa-item-memo-title {
            /* font-size: 80%; */
            padding: 10px;
            padding-bottom: 5px;
            padding-top: 5px;
            border-bottom: gray solid 1px;
        }

        .qa-item-memo-content {
            padding: 10px;
        }

        .content-highlight {
            border-radius: 4px;
            color: rgba(var(--v-theme-surface), 1);
            background-color: rgba(var(--v-theme-info), 1);
        }

    </style>
</head>


<body>

    <div id="app">
        <v-app>
            <v-theme-provider theme="system">

                <v-card>
                    <v-layout>
                        <v-navigation-drawer expand-on-hover permanent rail>

                            <v-list density="compact" nav>
                                <v-list-item prepend-icon="mdi-folder" title="My Files" value="myfiles"></v-list-item>
                                <v-list-item prepend-icon="mdi-account-multiple" title="Shared with me"
                                    value="shared"></v-list-item>
                                <v-list-item prepend-icon="mdi-star" title="Starred" value="starred"></v-list-item>
                            </v-list>
                        </v-navigation-drawer>

                        <v-main>
                            <v-sheet>
                                <div class="app-main">

                                    <div class="faq-view-content">
                                        <div class="header">
                                            <v-text-field v-model="keyword" label="検索キーワード" density="comfortable"
                                                center-affix clearable variant="underlined"
                                                @update:focused="updateFocused"></v-text-field>
                                            <v-select density="comfortable" v-model="selectedSearchTargets"
                                                :items="searchTargets" label="検索対象" multiple persistent-hint>
                                                <template v-slot:selection="{ item, index }">
                                                    <v-chip v-if="selectedSearchTargets.length != searchTargets.length"
                                                        :text="item.title"></v-chip>
                                                    <v-chip
                                                        v-if="selectedSearchTargets.length == searchTargets.length && index == 0"
                                                        text="すべて"></v-chip>
                                                </template>
                                            </v-select>
                                        </div>

                                        <div class="panes">
                                            <div class="panel first split-head">

                                                <div>
                                                    <v-btn variant="text" size="small" @click="allNodesSelect">選択</v-btn>
                                                    <v-btn variant="text" size="small" @click="allNodesDeselect">解除</v-btn>
                                                    <v-btn variant="text" size="small" @click="allNodesOpen">展開</v-btn>
                                                    <v-btn variant="text" size="small" @click="allNodesClose">折りたたむ</v-btn>
                                                </div>

                                                <v-divider></v-divider>

                                                <v-treeview height="100%" filterable :items="categoryTree"
                                                    :selected="selectedCategories" item-value="item.id"
                                                    item-title="item.text" item-children="children" density="compact"
                                                    selectable select-strategy="independent" open-on-click v-model:opened="openedNodes"
                                                    :search="categoryFilter" 
                                                    :custom-filter="treeFilter"
                                                    @update:selected="updateCategorySelected">

                                                </v-treeview>

                                            </div>
                                            <div class="splitter"></div>
                                            <div class="panel second">

                                                <v-virtual-scroll :items="filterItems.faqItems" height="100%">
                                                    <template v-slot:default="{ item, index }">
                                                        <div class="qa-item">
                                                            <div>
                                                                <div class="qa-item-head">

                                                                    <div>{{item.number}}</div>
                                                                    <div class="category">
                                                                        <span>{{ categoryNames[item.lv1] }} - {{
                                                                            categoryNames[item.lv2] }} - {{
                                                                            categoryNames[item.lv3] }}</span>
                                                                    </div>
                                                                </div>

                                                                <div>
                                                                    <div class="question-text">
                                                                        <template v-if="filterItems.highlightDataItems[index]?.question">
                                                                            <template v-for="el in filterItems.highlightDataItems[index]?.question">
                                                                                <span v-if="el.isHighlightTarget" class="content-highlight">{{el.text}}</span>
                                                                                <span v-if="!el.isHighlightTarget">{{el.text}}</span>
                                                                            </template>
                                                                        </template>
                                                                        <template v-if="!(filterItems.highlightDataItems[index]?.question)">{{item.question}}</template>
                                                                    </div>

                                                                    <div v-if="item.answer && item.answer.length > 0"
                                                                        readonly class="answer-text" draggable="false"
                                                                        contenteditable v-on:dragover="onInput"
                                                                        v-on:drop="onInput" v-on:keypress="onInput"
                                                                        v-on:paste="onInput" v-on:cut="onInput">
                                                                    
                                                                        <template v-if="filterItems.highlightDataItems[index]?.answer">
                                                                            <template v-for="el in filterItems.highlightDataItems[index]?.answer">
                                                                                <span v-if="el.isHighlightTarget" class="content-highlight">{{el.text}}</span>
                                                                                <span v-if="!el.isHighlightTarget">{{el.text}}</span>
                                                                            </template>
                                                                        </template>
                                                                        <template v-if="!(filterItems.highlightDataItems[index]?.answer)">{{item.answer}}</template>

                                                                    </div>

                                                                </div>
                                                            </div>

                                                            <div v-if="item.memo && item.memo.length > 0"
                                                                class="qa-item-memo-border">
                                                                <div class="qa-item-memo-title">メモ欄</div>
                                                                <div class="qa-item-memo-content">
                                                                    <template v-if="filterItems.highlightDataItems[index]?.memo">
                                                                        <template v-for="el in filterItems.highlightDataItems[index]?.memo">
                                                                            <span v-if="el.isHighlightTarget" class="content-highlight">{{el.text}}</span>
                                                                            <span v-if="!el.isHighlightTarget">{{el.text}}</span>
                                                                        </template>
                                                                    </template>
                                                                    <template v-if="!(filterItems.highlightDataItems[index]?.memo)">{{item.memo}}</template>
                                                                </div>
                                                            </div>

                                                        </div>
                                                        <v-divider></v-divider>
                                                    </template>
                                                </v-virtual-scroll>


                                            </div>

                                        </div>
                                    </div>

                                </div>
                            </v-sheet>
                        </v-main>


                    </v-layout>
                </v-card>


            </v-theme-provider>
        </v-app>
    </div>

    <script>

        function generateFaqData(data) {
            const tree = {};

            const lv1Items = [];
            const lv2Items = [];
            const lv3Items = [];

            const faqItems = [];
            const categoryNames = {};

            for (const item of data) {

                let lv1 = lv1Items.find(l => l.text == item.lv1);

                if (lv1 == undefined) {
                    lv1 = { id: crypto.randomUUID(), text: item.lv1, parentId: undefined };
                    categoryNames[lv1.id] = item.lv1;
                    lv1Items.push(lv1);
                }

                let lv2 = lv2Items.find(l => l.text == item.lv2 && l.parentId == lv1.id);

                if (lv2 == undefined) {
                    lv2 = { id: crypto.randomUUID(), text: item.lv2, parentId: lv1.id };
                    categoryNames[lv2.id] = item.lv2;
                    lv2Items.push(lv2);
                }

                let lv3 = lv3Items.find(l => l.text == item.lv3 && l.parentId == lv2.id);

                if (lv3 == undefined) {
                    lv3 = { id: crypto.randomUUID(), text: item.lv3, parentId: lv2.id };
                    categoryNames[lv3.id] = item.lv3;
                    lv3Items.push(lv3);
                }

                faqItems.push({ ...item, lv1: lv1.id, lv2: lv2.id, lv3: lv3.id });
            }

            return {
                categories: [...lv1Items, ...lv2Items, ...lv3Items],
                faqItems,
                categoryNames,
            }
        }

        const toCategoryTree = (categories, filter) => {

            const getFromParentId = (id) => {
                return categories.filter(item => item.parentId == id).map(item => {

                    const children = getFromParentId(item.id);

                    return {
                        item,
                        children: children.length > 0 ? children : undefined,
                    }
                });
            }

            return categories
                .filter(item => item.parentId == undefined)
                .map(item => ({ item, children: getFromParentId(item.id) }));
        }

        const matchTextArray = (textList, source) => {

            // const mode = 

            for (const text of textList) {

                if (source?.indexOf(text) > -1) return true;
                if (source?.indexOf(text.toUpperCase()) > -1) return true;
                if (source?.indexOf(text.toLowerCase()) > -1) return true;

                // if (source?.indexOf(text) == -1 && source?.indexOf(text.toUpperCase()) == -1 && source?.indexOf(text.toLowerCase()) == -1) {
                //     return false;
                // }
            }

            return false;
            // return true;
        }

        //文字列を分割して区切り文字を含んだ配列を返す
        const split2 = (text, delimiter) => {
            const result = [];

            let pre = 0;
            let index = text.indexOf(delimiter);

            while (index > -1) {

                if (pre + index > 0) {
                    result.push(text.substring(pre, index));
                }

                result.push(delimiter);

                pre = index + delimiter.length;
                index = text.indexOf(delimiter, index + delimiter.length);
            }

            if (pre < text.length) {
                result.push(text.substring(pre, text.length));
            }

            return result;
        }

        // ^https?://[\w.?=&#%~/-]+$

        const getHighlightTextStructureRegex = (keywords, source) => {

            if (!source) return undefined;

            const a = split(source, keywords[0]).map(text => ({ isHighlightTarget: keywords[0] == text, text }));

            // if (keywords.length == 1) return a;

            for (let i = 1; i < keywords.length; i++) {

                const keyword = keywords[i];

                for (let k = 0; k < a.length; k++) {

                    const current = a[k].text;

                    // console.log(current, keyword, source);

                    if (current.indexOf(keyword) > -1) {
                        const aa = split(current, keyword).map(text => ({ isHighlightTarget: keyword == text, text }));
                        a.splice(k, 1);
                        a.splice(k, 0, ...aa);
                        k += aa.length;
                    }
                }
            }

            return a;
        }

        const getHighlightTextStructure = (keywords, source) => {

            if (!source) return undefined;

            const a = split2(source, keywords[0]).map(text => ({ isHighlightTarget: keywords[0] == text, text }));

            // if (keywords.length == 1) return a;

            for (let i = 1; i < keywords.length; i++) {

                const keyword = keywords[i];

                for (let k = 0; k < a.length; k++) {

                    const current = a[k].text;

                    // console.log(current, keyword, source);

                    if (current.indexOf(keyword) > -1) {
                        const aa = split2(current, keyword).map(text => ({ isHighlightTarget: keyword == text, text }));
                        a.splice(k, 1);
                        a.splice(k, 0, ...aa);
                        k += aa.length;
                    }
                }
            }

            return a;
        }

        const highlightKeywords = (keywords, item) => {

            return {
                question: getHighlightTextStructure(keywords, item.question),
                answer: getHighlightTextStructure(keywords, item.answer),
                memo: getHighlightTextStructure(keywords, item.memo),
            }
        }

        const filterFaqItems = (keyword, items, serachTargets, selectedCategories, categoryNames) => {

            const faqItems = [];
            const highlightDataItems = [];
            const keywords = ((keyword ?? "").split(/\s/).filter(k => k.length > 0)) ?? [];
            const filterCategories = [];

            for (const item of items) {

                const matched = {
                    isQuestion: serachTargets.includes("Question") && matchTextArray(keywords, item.question ?? ""),
                    isAnswer: serachTargets.includes("Answer") && matchTextArray(keywords, item.answer ?? ""),
                    isNumber: serachTargets.includes("通し番号") && matchTextArray(keywords, item.number ?? ""),
                    isLv1: serachTargets.includes("区分1") && matchTextArray(keywords, categoryNames[item.lv1]),
                    isLv2: serachTargets.includes("区分2") && matchTextArray(keywords, categoryNames[item.lv2]),
                    isLv3: serachTargets.includes("区分3") && matchTextArray(keywords, categoryNames[item.lv3]),
                    isMemo: serachTargets.includes("メモ欄") && matchTextArray(keywords, item.memo ?? ""),
                }

                const isMatched = Object.values(matched).find(m => m) || keywords.length == 0;

                if (isMatched) {

                    const selectedLv1 = selectedCategories.includes(item.lv1);
                    const selectedLv2 = selectedCategories.includes(item.lv2);
                    const selectedLv3 = selectedCategories.includes(item.lv3);

                    // console.log(matched, isMatched, selectedLv1, selectedLv2, selectedLv3);

                    if (selectedLv1 && selectedLv2 && selectedLv3) {

                        faqItems.push(item);

                        if (keyword) {
                            const h = highlightKeywords(keywords, item);
                            highlightDataItems.push(h);
                        }
                    }

                    if (!filterCategories.includes(item.lv3)) filterCategories.push(item.lv3);
                }
            }

            return { faqItems, highlightDataItems, categories: filterCategories };
        }


        const getChildren = (c, id) => {
            const items = c.filter(item => item.parentId == id);
            const results = [];

            for (const item of items) {
                results.push(item.id);
                results.push(...getChildren(c, item.id));
            }

            return results;
        }

        const onInput = (e) => {
            e.preventDefault();
        }

        const { createApp, ref, shallowRef, computed } = Vue
        const { createVuetify } = Vuetify

        const vuetify = createVuetify({
            theme: {
                defaultTheme: 'system',
            },
        });

        createApp({

            setup() {

                const faqObject = __faqObject;
                const { faqItems, categories, categoryNames } = generateFaqData(faqObject);

                const keyword = ref("");
                const categoryFilter = ref("");

                const searchTargets = ["区分1", "区分2", "区分3", "通し番号", "Question", "Answer", "メモ欄"];
                const selectedSearchTargets = shallowRef([...searchTargets]);
                const selectedCategories = shallowRef(categories.map(item => item.id));

                const filterItems = computed(() => filterFaqItems(keyword.value, faqItems, selectedSearchTargets.value, selectedCategories.value, categoryNames));
                const filterCategories = shallowRef([]);

                const openedNodes = shallowRef([]);
                const categoryTree = ref(toCategoryTree(categories, filterItems.value.categories));

                const treeFilter = (value, search, item) => {
                    return filterCategories.value.includes(item.value);
                }

                const allNodesOpen = () => {
                    openedNodes.value = [...categories.map(item => item.id)];
                }

                const allNodesClose = () => {
                    openedNodes.value = [];
                }

                const allNodesSelect = () => {
                    selectedCategories.value = [...categories.map(item => item.id)];
                }

                const allNodesDeselect = () => {
                    selectedCategories.value = [];                    
                }

                const updateFocused = (state) => {
                    if (!state) {
                        categoryFilter.value = keyword.value;
                        filterCategories.value = [...filterItems.value.categories];
                    }
                }

                const updateCategorySelected = (value, item) => {

                    let selected = [...value];

                    const a = selectedCategories.value.length < value.length ? selectedCategories.value : value;
                    const b = selectedCategories.value.length < value.length ? value : selectedCategories.value;

                    let state;

                    for (const item of b) {
                        if (!a.includes(item)) {
                            const isChecked = value.includes(item);
                            state = { id: item, isChecked };
                            break;
                        }
                    }

                    if (state) {

                        const children = getChildren(categories, state.id);

                        if (state.isChecked) {
                            selected.push(...children);
                        } else {
                            selected = selected.filter(id => !children.includes(id));
                        }
                    }

                    selectedCategories.value = selected;
                }


                return {
                    keyword,
                    faqItems,
                    filterItems,

                    openedNodes,
                    allNodesOpen,
                    allNodesClose,
                    allNodesSelect,
                    allNodesDeselect,

                    categoryTree,
                    selectedCategories,
                    searchTargets,
                    selectedSearchTargets,

                    updateFocused,
                    updateCategorySelected,

                    categoryFilter,
                    treeFilter,

                    categoryNames,

                    onInput,
                }
            },

        }).use(vuetify).mount('#app');

        mountSplitters(".panes");


    </script>

</body>

</html>